name: CI Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master, dev]

jobs:
  # Step 1: Basic sanity checks - build, style, format
  basic-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: Install dependencies
      run: |
        uv sync --dev
        
    - name: Check Python syntax
      run: |
        echo "ðŸ” Checking Python syntax..."
        # Check all Python files for syntax errors
        find . -name "*.py" -not -path "./.venv/*" -not -path "./.git/*" -exec python -m py_compile {} \;
        echo "âœ… Python syntax check passed"
        
    - name: Check code style with ruff
      run: |
        echo "ðŸ”§ Running ruff linting checks..."
        # Use the pyproject.toml configuration for consistent rules
        uv run ruff check .
        echo "âœ… Code style check passed"
        
    - name: Check for basic security issues
      run: |
        echo "ðŸ”’ Checking for basic security issues..."
        # Check for hardcoded secrets (excluding examples and tests)
        if grep -r -i "password\|secret\|key\|token" . --exclude-dir=.git --exclude-dir=.venv --exclude="*.md" | grep -v -i "example\|test\|dummy\|placeholder"; then
          echo "âŒ Potential secrets found in code"
          exit 1
        fi
        echo "âœ… No obvious secrets found"
        
    - name: Validate configuration files
      run: |
        echo "âš™ï¸ Validating configuration files..."
        # Check YAML files
        find . -name "*.yml" -o -name "*.yaml" | while read file; do
          python -c "import yaml; yaml.safe_load(open('$file'))" || (echo "âŒ Invalid YAML: $file" && exit 1)
        done
        # Check JSON files  
        find . -name "*.json" | while read file; do
          python -c "import json; json.load(open('$file'))" || (echo "âŒ Invalid JSON: $file" && exit 1)
        done
        echo "âœ… Configuration files are valid"

  # Step 2: Build and test (only if basic checks pass)
  build-and-test:
    runs-on: ubuntu-latest
    needs: basic-checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: Install dependencies
      run: |
        uv sync --dev
        
    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        # Run model-serving tests
        if [ -d "model-serving/tests" ]; then
          uv run pytest model-serving/tests/ -v --tb=short
        else
          echo "No model-serving tests found"
        fi
        # Run model-sim tests
        if [ -d "model-sim/tests" ]; then
          uv run pytest model-sim/tests/ -v --tb=short
        else
          echo "No model-sim tests found"
        fi
        
    - name: Test Docker build
      run: |
        echo "ðŸ³ Testing Docker build..."
        if [ -f "model-serving/Dockerfile" ]; then
          docker build -t model-serving:test ./model-serving/
          echo "âœ… Docker build successful"
        else
          echo "No Dockerfile found"
        fi

  # Step 3: Summary (only if all checks pass)
  summary:
    runs-on: ubuntu-latest
    needs: [basic-checks, build-and-test]
    if: always()
    
    steps:
    - name: CI Summary
      run: |
        echo "## CI Checks Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Basic Checks (Syntax, Format, Lint) | ${{ needs.basic-checks.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.basic-checks.result }}" = "success" ] && [ "${{ needs.build-and-test.result }}" = "success" ]; then
          echo "âœ… **All checks passed!** Ready to merge." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some checks failed.** Please fix the issues before merging." >> $GITHUB_STEP_SUMMARY
        fi
