name: CI Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master, dev]

jobs:
  # Step 1: Basic sanity checks - build, style, format
  basic-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install basic dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff==0.1.8 pyyaml
        
    - name: Check Python syntax
      run: |
        echo "🔍 Checking Python syntax..."
        # Check all Python files for syntax errors
        find . -name "*.py" -not -path "./.venv/*" -not -path "./.git/*" -exec python -m py_compile {} \;
        echo "✅ Python syntax check passed"
        
    - name: Check code style with ruff
      run: |
        echo "🔧 Running ruff linting checks..."
        # Use the pyproject.toml configuration for consistent rules
        ruff check .
        echo "✅ Code style check passed"
        
    - name: Check for basic security issues
      run: |
        echo "🔒 Checking for basic security issues..."
        # Check for hardcoded secrets (excluding examples and tests)
        if grep -r -i "password\|secret\|key\|token" . --exclude-dir=.git --exclude-dir=.venv --exclude="*.md" | grep -v -i "example\|test\|dummy\|placeholder"; then
          echo "❌ Potential secrets found in code"
          exit 1
        fi
        echo "✅ No obvious secrets found"
        
    - name: Validate configuration files
      run: |
        echo "⚙️ Validating configuration files..."
        # Check YAML files
        find . -name "*.yml" -o -name "*.yaml" | while read file; do
          python -c "import yaml; yaml.safe_load(open('$file'))" || (echo "❌ Invalid YAML: $file" && exit 1)
        done
        # Check JSON files  
        find . -name "*.json" | while read file; do
          python -c "import json; json.load(open('$file'))" || (echo "❌ Invalid JSON: $file" && exit 1)
        done
        echo "✅ Configuration files are valid"

  # Step 2: Build and test (only if basic checks pass)
  build-and-test:
    runs-on: ubuntu-latest
    needs: basic-checks
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install model-serving dependencies
        if [ -f "model-serving/requirements.txt" ]; then
          pip install -r model-serving/requirements.txt
        fi
        # Install model-sim dependencies  
        if [ -f "model-sim/pyproject.toml" ]; then
          pip install -e model-sim/
        fi
        # Install test dependencies
        pip install pytest pytest-cov
        
    - name: Run tests
      run: |
        echo "🧪 Running tests..."
        # Run model-serving tests
        if [ -d "model-serving/tests" ]; then
          pytest model-serving/tests/ -v --tb=short
        else
          echo "No model-serving tests found"
        fi
        # Run model-sim tests
        if [ -d "model-sim/tests" ]; then
          pytest model-sim/tests/ -v --tb=short
        else
          echo "No model-sim tests found"
        fi
        
    - name: Test Docker build
      run: |
        echo "🐳 Testing Docker build..."
        if [ -f "model-serving/Dockerfile" ]; then
          docker build -t model-serving:test ./model-serving/
          echo "✅ Docker build successful"
        else
          echo "No Dockerfile found"
        fi

  # Step 3: Summary (only if all checks pass)
  summary:
    runs-on: ubuntu-latest
    needs: [basic-checks, build-and-test]
    if: always()
    
    steps:
    - name: CI Summary
      run: |
        echo "## CI Checks Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Basic Checks (Syntax, Format, Lint) | ${{ needs.basic-checks.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Build & Test | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.basic-checks.result }}" = "success" ] && [ "${{ needs.build-and-test.result }}" = "success" ]; then
          echo "✅ **All checks passed!** Ready to merge." >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **Some checks failed.** Please fix the issues before merging." >> $GITHUB_STEP_SUMMARY
        fi
